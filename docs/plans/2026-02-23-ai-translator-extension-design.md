# AI 語言學習翻譯外掛 - 設計文件

**日期**: 2026-02-23
**目標**: 建立一個瀏覽器外掛，當使用者選取文字時，根據上下文顯示 AI 生成的解釋，並可儲存到個人單字表

---

## 核心需求

### 支援語言
- 英文
- 日文
- 自動偵測語言類型

### 支援瀏覽器
- Chrome
- Microsoft Edge
- 使用 Manifest V3 標準

### AI 服務
- 預設使用 Claude API
- 可切換至其他模型：GPT-5.2, Grok-4, Grok-4-fast-non-reasoning
- 支援自訂 API endpoint 和模型名稱
- 使用者自行提供 API key

---

## 架構設計

### 檔案結構

```
ai_translator_extension/
├── manifest.json          # 外掛配置檔
├── background.js          # 背景服務（API 呼叫）
├── content.js            # 內容腳本（文字選取偵測）
├── popup.html            # 單字表管理介面
├── popup.js              # 單字表邏輯
├── popup.css             # 單字表樣式
├── settings.html         # 設定頁面
├── settings.js           # 設定邏輯
├── settings.css          # 設定樣式
├── styles.css            # 浮動視窗樣式
└── icons/                # 外掛圖示
    ├── icon16.png
    ├── icon48.png
    └── icon128.png
```

### 三大組件

#### 1. Content Script (content.js)
**職責**: 網頁互動層
- 偵測使用者文字選取
- 顯示點擊圖示 💡
- 收集選取文字和上下文
- 顯示浮動視窗
- 處理「加入單字表」動作

#### 2. Background Script (background.js)
**職責**: API 通訊層
- 呼叫 Claude API（或其他 AI 服務）
- 管理 API 設定（endpoint, key, model）
- 處理 API 回應和錯誤
- 管理單字資料的儲存

#### 3. Popup (popup.html/js)
**職責**: 單字表管理
- 顯示已儲存的單字列表
- 語言篩選（全部/英文/日文）
- 搜尋功能
- 刪除單字
- 匯出/匯入功能
- 連結到設定頁面

---

## 使用者體驗流程

### 主要流程

1. **選取文字**
   - 使用者在網頁上選取文字
   - 文字出現藍色反白

2. **顯示圖示**
   - 選取文字右上角出現小圖示 💡
   - 圖示淡入動畫
   - 點擊網頁其他地方則圖示消失

3. **請求翻譯**
   - 點擊圖示
   - 浮動視窗立即出現，顯示「🤔 AI 正在思考中...」
   - Content Script 發送訊息給 Background Script
   - Background Script 呼叫 API

4. **顯示結果**
   - 浮動視窗更新，顯示：
     - 📖 翻譯
     - 📝 詞性
     - 💡 說明
     - ✨ 例句（1-2 個）
   - 底部按鈕：⭐ 加入單字表 / ✕ 關閉

5. **儲存單字（可選）**
   - 點擊「加入單字表」
   - 按鈕變成 ✓ 已加入
   - 資料儲存到 chrome.storage.local

### 浮動視窗設計

```
┌─────────────────────────────────┐
│ 🌐 ephemeral               [✕] │  標題列
├─────────────────────────────────┤
│ 📖 翻譯                          │
│    短暫的；轉瞬即逝的            │
│                                 │
│ 📝 詞性：形容詞 (adjective)      │
│                                 │
│ 💡 說明                          │
│    形容存在時間很短、容易消失的  │
│    事物。常用於描述記憶、美好時  │
│    刻或數位資料。                │
│                                 │
│ ✨ 例句                          │
│    • The ephemeral nature of    │
│      social media posts...      │
│      (社群媒體貼文的短暫性...)   │
│                                 │
├─────────────────────────────────┤
│  [⭐ 加入單字表]    [✕ 關閉]   │
└─────────────────────────────────┘
```

**設計特點**:
- 白色背景，淡陰影
- 圓角設計
- 智能定位（避免超出螢幕）
- Emoji 圖示清晰分區

---

## 單字表管理介面

### 主介面佈局

```
┌────────────────────────────────────────┐
│  📚 我的單字表                    [⚙️]  │
├────────────────────────────────────────┤
│  🔍 [搜尋單字...]                      │
├────────────────────────────────────────┤
│  [🌐 全部] [🇬🇧 英文] [🇯🇵 日文]      │  語言篩選
├────────────────────────────────────────┤
│  共 127 個單字 (英文 89 | 日文 38)    │
│  [📥 匯入] [📤 匯出]                   │
├────────────────────────────────────────┤
│  [單字卡片列表，可捲動]                │
└────────────────────────────────────────┘
```

### 功能列表

#### 語言篩選
- 🌐 全部：顯示所有單字
- 🇬🇧 英文：只顯示英文單字
- 🇯🇵 日文：只顯示日文單字
- 自動偵測語言（根據字符判斷）

#### 搜尋功能
- 即時搜尋
- 可搜尋原文或翻譯

#### 單字卡片
- 顯示：原文、翻譯、日期、來源
- 點擊展開查看完整解釋和例句
- 刪除按鈕（需確認）

#### 匯出功能
- JSON 格式（完整資料，可再匯入）
- CSV 格式（適合 Excel 和 Anki）
- 可選擇「匯出全部」或「只匯出已篩選的」

#### 匯入功能
- 從 JSON 檔案匯入
- 檢查格式和重複項
- 顯示匯入結果統計

---

## API 設定介面

### 設定頁面

```
┌────────────────────────────────────────┐
│  ⚙️ 設定                      [← 返回]  │
├────────────────────────────────────────┤
│  🤖 AI 服務設定                        │
│  ┌──────────────────────────────────┐ │
│  │ API Endpoint (網址)              │ │
│  │ [可自由輸入]                     │ │
│  │                                  │ │
│  │ API Key (金鑰)                   │ │
│  │ [•••••••••••••]        [👁️]    │ │
│  │                                  │ │
│  │ Model (模型)                     │ │
│  │ [下拉選單 + 自訂選項]            │ │
│  └──────────────────────────────────┘ │
│                                        │
│  [🧪 測試連線]  [💾 儲存設定]         │
└────────────────────────────────────────┘
```

### 支援的模型

**預設選項**:
- claude-opus-4.6
- claude-sonnet-4
- claude-haiku-4
- gpt-5.2
- grok-4
- grok-4-fast-non-reasoning
- ✏️ 自訂...

**自訂選項**:
- 選擇「自訂」後出現文字輸入框
- 可輸入任何模型名稱

### 測試連線功能
- 發送測試請求驗證設定
- 顯示成功或錯誤訊息

---

## 資料結構

### 單字資料格式

```json
{
  "id": "1708675200000",
  "word": "ephemeral",
  "language": "en",
  "translation": "短暫的；轉瞬即逝的",
  "partOfSpeech": "形容詞",
  "explanation": "形容存在時間很短...",
  "examples": [
    {
      "sentence": "The ephemeral nature...",
      "translation": "社群媒體貼文的短暫性..."
    }
  ],
  "context": "...social media posts are ephemeral...",
  "sourceUrl": "https://nytimes.com/article/...",
  "savedAt": "2026-02-23T14:32:00Z"
}
```

### 設定資料格式

```json
{
  "apiEndpoint": "https://api.anthropic.com/v1/",
  "apiKey": "sk-ant-xxxxx",
  "model": "claude-sonnet-4",
  "stats": {
    "totalQueries": 247,
    "lastUsed": "2026-02-23T14:32:00Z"
  }
}
```

---

## 通訊機制

### 訊息類型

#### Content → Background: 請求翻譯
```javascript
{
  action: "translate",
  data: {
    text: "ephemeral",
    context: "...social media posts are ephemeral...",
    language: "auto"
  }
}
```

#### Background → Content: 翻譯結果
```javascript
{
  success: true,
  data: {
    word: "ephemeral",
    translation: "短暫的；轉瞬即逝的",
    partOfSpeech: "形容詞",
    explanation: "...",
    examples: [...]
  }
}
```

#### Content → Background: 儲存單字
```javascript
{
  action: "saveWord",
  data: {
    word: "ephemeral",
    translation: "...",
    sourceUrl: "https://nytimes.com/..."
  }
}
```

---

## 錯誤處理

### 錯誤情境與處理

1. **API Key 無效**
   - 顯示友善錯誤訊息
   - 提供「前往設定」按鈕

2. **網路連線失敗**
   - 顯示錯誤訊息
   - 提供「重試」按鈕

3. **請求超時**
   - 30 秒超時限制
   - 提供重試選項

4. **文字過長**
   - 限制 1000 字
   - 提示選取較短片段

5. **首次使用未設定**
   - 歡迎訊息
   - 引導至設定頁面

### 錯誤處理原則
- 🎯 明確說明問題
- 🔧 提供解決方案
- 😊 友善的語言
- 📝 在 console 記錄詳細錯誤

---

## 安全性與隱私

### API Key 保護
- 儲存在 chrome.storage.local
- 只在 Background Script 中使用
- 設定頁面預設隱藏顯示

### 資料隱私
- 所有單字資料僅存本地
- 不上傳到第三方伺服器
- 只有選取的文字傳送給 AI API

### 權限需求
```json
{
  "permissions": [
    "storage",
    "activeTab"
  ],
  "host_permissions": [
    "https://api.anthropic.com/*",
    "https://api.openai.com/*",
    "https://api.x.ai/*"
  ]
}
```

---

## 資源消耗評估

### 記憶體使用
- 待機狀態: ~5-10 MB
- 工作狀態: ~15-20 MB
- 相比：YouTube 分頁 ~200-300 MB

### CPU 使用
- 待機: 幾乎為零
- 工作: 輕量 DOM 操作
- AI 運算在雲端執行

### 網路使用
- 每次查詢: ~1-5 KB 上傳
- AI 回應: ~2-10 KB 下載
- 不會影響正常瀏覽

---

## 技術選擇

### 前端
- 純 JavaScript (ES6+)
- 無外部框架（減少體積）
- Chrome Extension Manifest V3

### 樣式
- 原生 CSS
- Flexbox 佈局
- CSS 變數統一主題

### 儲存
- chrome.storage.local
- JSON 格式

### API 通訊
- Fetch API
- 異步處理

---

## 開發優先順序

### Phase 1: 核心功能（MVP）
1. ✅ 基本文字選取偵測
2. ✅ 呼叫 Claude API
3. ✅ 顯示浮動視窗
4. ✅ 儲存到本地
5. ✅ 基本設定頁面

### Phase 2: 完善體驗
1. ✅ 語言自動偵測
2. ✅ 語言篩選功能
3. ✅ 搜尋功能
4. ✅ 匯出/匯入

### Phase 3: 進階功能
1. ✅ 多模型支援
2. ✅ 自訂 API endpoint
3. ✅ 使用統計
4. ✅ 完善錯誤處理

---

## 未來可能擴充

- 複習功能（閃卡模式）
- 分類管理（資料夾/標籤）
- 雲端同步
- 更多語言支援
- Anki 整合
- 發音功能
- Firefox 版本

---

## 成功指標

- ✅ 選取文字到顯示解釋 < 3 秒
- ✅ 介面流暢不卡頓
- ✅ 錯誤都有友善提示
- ✅ 資料可靠儲存和匯出
- ✅ 不影響正常瀏覽體驗
